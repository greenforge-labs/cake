// auto-generated DO NOT EDIT

#pragma once

#include <memory>
#include <rclcpp/rclcpp.hpp>
{% for include in message_includes -%}
#include <{{ include }}>
{% endfor -%}
#include <cake/base_node.hpp>
#include <cake/context.hpp>
{%- if subscribers %}
#include <cake/subscriber.hpp>
{%- endif %}
{%- if services %}
#include <cake/service.hpp>
{%- endif %}
{%- if actions %}
#include <cake/action_server.hpp>
{%- endif %}
#include <{{ package_name }}/{{ node_name }}_parameters.hpp>

namespace {{ implementation_namespace }} {
{%- if publishers %}

template <typename ContextType> struct {{ class_name }}Publishers {
{%- for pub in publishers %}
    rclcpp::Publisher<{{ pub.msg_type }}>::SharedPtr {{ pub.field_name }};
{%- endfor %}
};
{%- else %}

template <typename ContextType> struct {{ class_name }}Publishers {};
{%- endif %}
{%- if subscribers %}

template <typename ContextType> struct {{ class_name }}Subscribers {
{%- for sub in subscribers %}
    std::shared_ptr<cake::Subscriber<{{ sub.msg_type }}, ContextType>> {{ sub.field_name }};
{%- endfor %}
};
{%- else %}

template <typename ContextType> struct {{ class_name }}Subscribers {};
{%- endif %}
{%- if services %}

template <typename ContextType> struct {{ class_name }}Services {
{%- for srv in services %}
    std::shared_ptr<cake::Service<{{ srv.service_type }}, ContextType>> {{ srv.field_name }};
{%- endfor %}
};
{%- else %}

template <typename ContextType> struct {{ class_name }}Services {};
{%- endif %}
{%- if service_clients %}

template <typename ContextType> struct {{ class_name }}ServiceClients {
{%- for client in service_clients %}
    rclcpp::Client<{{ client.service_type }}>::SharedPtr {{ client.field_name }};
{%- endfor %}
};
{%- else %}

template <typename ContextType> struct {{ class_name }}ServiceClients {};
{%- endif %}
{%- if actions %}

template <typename ContextType> struct {{ class_name }}Actions {
{%- for action in actions %}
    std::shared_ptr<cake::SingleGoalActionServer<{{ action.action_type }}>> {{ action.field_name }};
{%- endfor %}
};
{%- else %}

template <typename ContextType> struct {{ class_name }}Actions {};
{%- endif %}
{%- if action_clients %}

template <typename ContextType> struct {{ class_name }}ActionClients {
{%- for client in action_clients %}
    rclcpp_action::Client<{{ client.action_type }}>::SharedPtr {{ client.field_name }};
{%- endfor %}
};
{%- else %}

template <typename ContextType> struct {{ class_name }}ActionClients {};
{%- endif %}

template <typename DerivedContextType> struct {{ class_name }}Context : cake::Context {
    {{ class_name }}Publishers<DerivedContextType> publishers;
    {{ class_name }}Subscribers<DerivedContextType> subscribers;
    {{ class_name }}Services<DerivedContextType> services;
    {{ class_name }}ServiceClients<DerivedContextType> service_clients;
    {{ class_name }}Actions<DerivedContextType> actions;
    {{ class_name }}ActionClients<DerivedContextType> action_clients;
    std::shared_ptr<ParamListener> param_listener;
    Params params;
};


template <
    typename ContextType,
    auto init_func,
    auto extend_options = [](rclcpp::NodeOptions options) { return options; }>
class {{ class_name }}Base : public cake::BaseNode<"{{ node_name }}", extend_options> {
  public:
    explicit {{ class_name }}Base(const rclcpp::NodeOptions &options) : cake::BaseNode<"{{ node_name }}", extend_options>(options) {
        static_assert(
            std::is_base_of_v<{{ class_name }}Context<ContextType>, ContextType>, "ContextType must be a child of {{ class_name }}Context"
        );

        // init context
        auto ctx = std::make_shared<ContextType>();
        ctx->node = this->node_;
{%- if publishers %}

        // init publishers
{%- for pub in publishers %}
        ctx->publishers.{{ pub.field_name }} = ctx->node->template create_publisher<{{ pub.msg_type }}>("{{ pub.topic }}", {{ pub.qos_code }});
{%- endfor %}

{%- endif %}
{%- if subscribers %}
        // init subscribers
{%- for sub in subscribers %}
        ctx->subscribers.{{ sub.field_name }} = cake::create_subscriber<{{ sub.msg_type }}>(ctx, "{{ sub.topic }}", {{ sub.qos_code }});
{%- endfor %}

{%- endif %}
{%- if services %}
        // init services
{%- for srv in services %}
        ctx->services.{{ srv.field_name }} = cake::create_service<{{ srv.service_type }}>(ctx, "{{ srv.name }}"{% if srv.qos_code %}, {{ srv.qos_code }}{% endif %});
{%- endfor %}

{%- endif %}
{%- if service_clients %}
        // init service clients
{%- for client in service_clients %}
        ctx->service_clients.{{ client.field_name }} = ctx->node->template create_client<{{ client.service_type }}>("{{ client.name }}"{% if client.qos_code %}, {{ client.qos_code }}{% endif %});
{%- endfor %}

{%- endif %}
{%- if actions %}
        // init actions
{%- for action in actions %}
        ctx->actions.{{ action.field_name }} = cake::create_single_goal_action_server<{{ action.action_type }}>(ctx, "{{ action.name }}");
{%- endfor %}

{%- endif %}
{%- if action_clients %}
        // init action clients
{%- for client in action_clients %}
        ctx->action_clients.{{ client.field_name }} = rclcpp_action::create_client<{{ client.action_type }}>(ctx->node, "{{ client.name }}");
{%- endfor %}

{%- endif %}
        // init parameters
        ctx->param_listener = std::make_shared<ParamListener>(ctx->node);
        ctx->params = ctx->param_listener->get_params();

        init_func(ctx);
    }
};

} // namespace {{ implementation_namespace }}
