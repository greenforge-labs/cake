$schema: https://json-schema.org/draft/2020-12/schema
title: Cake Node Interface
description: Schema for Cake ROS2 node interface YAML files
type: object
required:
  - node
additionalProperties: false

properties:
  node:
    $ref: "#/$defs/node"
  parameters:
    type: object
    description: ROS parameters for generate_parameter_library (see parameter.schema.yaml)
    additionalProperties:
      $ref: "parameter.schema.yaml#/$defs/parameter_definition"
  publishers:
    type: array
    description: List of topic publishers
    items:
      $ref: "#/$defs/publisher"
  subscribers:
    type: array
    description: List of topic subscribers
    items:
      $ref: "#/$defs/subscriber"
  services:
    type: array
    description: List of service servers
    items:
      $ref: "#/$defs/service"
  service_clients:
    type: array
    description: List of service clients
    items:
      $ref: "#/$defs/serviceClient"
  actions:
    type: array
    description: List of action servers
    items:
      $ref: "#/$defs/action"
  action_clients:
    type: array
    description: List of action clients
    items:
      $ref: "#/$defs/actionClient"

$defs:
  # Parameter reference pattern: ${param:parameter_name}
  parameterRef:
    type: string
    pattern: '^\$\{param:[a-zA-Z_][a-zA-Z0-9_]*\}$'

  node:
    type: object
    description: Node metadata
    required:
      - name
    additionalProperties: false
    properties:
      name:
        type: string
        description: Node name. Use ${THIS_NODE} to substitute from build system.
        pattern: ^(\$\{THIS_NODE\}|[a-zA-Z][a-zA-Z0-9_]*)$
      package:
        type: string
        description: Package name. Use ${THIS_PACKAGE} to substitute from build system.
        pattern: ^(\$\{THIS_PACKAGE\}|[a-zA-Z][a-zA-Z0-9_]*)$

  topicName:
    type: string
    description: "ROS topic name. Valid characters: letters, digits, forward slash (/), underscore (_)"
    pattern: ^[a-zA-Z0-9/_]+$

  rosMessageType:
    type: string
    description: "ROS message type in format: package/msg/TypeName"
    pattern: ^[a-zA-Z][a-zA-Z0-9_]*/msg/[A-Z][a-zA-Z0-9]*$
    examples:
      - std_msgs/msg/String
      - geometry_msgs/msg/Twist
      - sensor_msgs/msg/JointState

  rosServiceType:
    type: string
    description: "ROS service type in format: package/srv/TypeName"
    pattern: ^[a-zA-Z][a-zA-Z0-9_]*/srv/[A-Z][a-zA-Z0-9]*$
    examples:
      - std_srvs/srv/Trigger
      - example_interfaces/srv/AddTwoInts

  rosActionType:
    type: string
    description: "ROS action type in format: package/action/TypeName"
    pattern: ^[a-zA-Z][a-zA-Z0-9_]*/action/[A-Z][a-zA-Z0-9]*$
    examples:
      - example_interfaces/action/Fibonacci
      - nav2_msgs/action/NavigateToPose

  qos:
    type: object
    description: QoS configuration for publishers and subscribers. Fields can use ${param:name} to reference read_only parameters.
    additionalProperties: false
    required:
      - history
      - reliability
    properties:
      history:
        description: "History policy: positive integer for KEEP_LAST(n), 'ALL' for KEEP_ALL, or ${param:name} reference"
        oneOf:
          - type: integer
            minimum: 1
          - const: "ALL"
          - $ref: "#/$defs/parameterRef"
      reliability:
        description: "Reliability policy or ${param:name} reference"
        oneOf:
          - enum: [BEST_EFFORT, RELIABLE]
          - $ref: "#/$defs/parameterRef"
      durability:
        description: "Durability policy or ${param:name} reference"
        oneOf:
          - enum: [TRANSIENT_LOCAL, VOLATILE]
          - $ref: "#/$defs/parameterRef"
      deadline_ms:
        description: "Deadline duration in milliseconds or ${param:name} reference"
        oneOf:
          - type: integer
            minimum: 0
          - $ref: "#/$defs/parameterRef"
      lifespan_ms:
        description: "Lifespan duration in milliseconds or ${param:name} reference"
        oneOf:
          - type: integer
            minimum: 0
          - $ref: "#/$defs/parameterRef"
      liveliness:
        description: "Liveliness policy or ${param:name} reference"
        oneOf:
          - enum: [AUTOMATIC, MANUAL_BY_TOPIC]
          - $ref: "#/$defs/parameterRef"
      lease_duration_ms:
        description: "Liveliness lease duration in milliseconds or ${param:name} reference"
        oneOf:
          - type: integer
            minimum: 0
          - $ref: "#/$defs/parameterRef"

  publisher:
    type: object
    description: Topic publisher definition
    required:
      - topic
      - type
      - qos
    additionalProperties: false
    properties:
      topic:
        $ref: "#/$defs/topicName"
        description: Topic name to publish on
      type:
        $ref: "#/$defs/rosMessageType"
        description: ROS message type
      qos:
        $ref: "#/$defs/qos"
        description: QoS configuration (required for publishers)
      manually_created:
        type: boolean
        description: If true, skip code generation for this publisher (for documentation only)
        default: false
    if:
      properties:
        manually_created:
          const: true
      required:
        - manually_created
    then:
      required:
        - topic

  subscriber:
    type: object
    description: Topic subscriber definition
    required:
      - topic
      - type
      - qos
    additionalProperties: false
    properties:
      topic:
        $ref: "#/$defs/topicName"
        description: Topic name to subscribe to
      type:
        $ref: "#/$defs/rosMessageType"
        description: ROS message type
      qos:
        $ref: "#/$defs/qos"
        description: QoS configuration (required for subscribers)
      manually_created:
        type: boolean
        description: If true, skip code generation for this subscriber (for documentation only)
        default: false

  service:
    type: object
    description: Service server definition
    required:
      - name
      - type
    additionalProperties: false
    properties:
      name:
        $ref: "#/$defs/topicName"
        description: Service name
      type:
        $ref: "#/$defs/rosServiceType"
        description: ROS service type
      manually_created:
        type: boolean
        description: If true, skip code generation for this service (for documentation only)
        default: false

  serviceClient:
    type: object
    description: Service client definition
    required:
      - name
      - type
    additionalProperties: false
    properties:
      name:
        $ref: "#/$defs/topicName"
        description: Service name to connect to
      type:
        $ref: "#/$defs/rosServiceType"
        description: ROS service type
      manually_created:
        type: boolean
        description: If true, skip code generation for this service client (for documentation only)
        default: false

  action:
    type: object
    description: Action server definition
    required:
      - name
      - type
    additionalProperties: false
    properties:
      name:
        $ref: "#/$defs/topicName"
        description: Action name
      type:
        $ref: "#/$defs/rosActionType"
        description: ROS action type
      manually_created:
        type: boolean
        description: If true, skip code generation for this action server (for documentation only)
        default: false

  actionClient:
    type: object
    description: Action client definition
    required:
      - name
      - type
    additionalProperties: false
    properties:
      name:
        $ref: "#/$defs/topicName"
        description: Action name to connect to
      type:
        $ref: "#/$defs/rosActionType"
        description: ROS action type
      manually_created:
        type: boolean
        description: If true, skip code generation for this action client (for documentation only)
        default: false
